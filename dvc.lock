training_tfidf_model:
  cmd: python3 -m purano.training.train_tfidf --config-file configs/training/tfidf.jsonnet
    --input-file data/documents/ru_tg_0511_0517.jsonl --output-file models/tfidf/ru_idfs.txt
  deps:
  - path: data/documents/ru_tg_0511_0517.jsonl
    md5: da62375b0016e60e5542be00534c3a2c
  - path: purano/training/models/tfidf.py
    md5: c05494f9ca21d65201a713d1d07dcc65
  - path: purano/training/train_tfidf.py
    md5: c4770f034fa35bbb80b710a7ed319f79
  params:
    configs/training/tfidf.jsonnet:
      max_df: 0.2
      min_df: 20
  outs:
  - path: models/tfidf/ru_idfs.txt
    md5: 124440e90f2533842f8157b9af8f8a1e
training_text2title_model:
  cmd: python3 -m purano.training.train_text2title --config-file configs/training/text2title.jsonnet
    --train-file data/documents/ru_tg_1101_0510.jsonl.tar.gz --val-file data/documents/ru_tg_0511_0517.jsonl
    --output-title-model-path models/text2title/ru_ft_title_embedder.pt --output-text-model-path
    models/text2title/ru_ft_text_embedder.pt --train-sample-rate 0.2 --val-sample-rate
    0.2
  deps:
  - path: data/documents/ru_tg_0511_0517.jsonl
    md5: da62375b0016e60e5542be00534c3a2c
  - path: data/documents/ru_tg_1101_0510.jsonl.tar.gz
    md5: ec5d8322478b4b7d8a17ea4db4998559
  - path: models/fasttext/ru_vectors_v3.bin
    md5: 5f67e2397661798d4f5091423efbcfde
  - path: purano/training/datasets/text2title.py
    md5: dd00d1b63d7d5f0ffa53ca093ea8b75e
  - path: purano/training/models/text2title.py
    md5: efe7f78b61cc930304dbd511955c5160
  - path: purano/training/train_text2title.py
    md5: 49f159cda7045e0b7094414136d16790
  params:
    configs/training/text2title.jsonnet:
      batch_size: 64
      epochs: 100
      ft_vector_model_path: models/fasttext/ru_vectors_v3.bin
      max_words: 150
      num_workers: 5
      patience: 4
  outs:
  - path: models/text2title/ru_ft_text_embedder.pt
    md5: ea7b700536bb4110f655b6876ad700c9
  - path: models/text2title/ru_ft_title_embedder.pt
    md5: 1666c2611289aeac007c3034f0df3f82
parse_0525:
  cmd: python3 -m purano.run_parse --inputs data/documents/ru_tg_0525.jsonl --fmt
    jsonl --output-file output/0525_parsed.db --cleaner-config configs/cleaner.jsonnet
  deps:
  - path: data/documents/ru_tg_0525.jsonl
    md5: 6713a796a0f2d50a7ec63a744b68eee1
  - path: purano/run_parse.py
    md5: 53670531f5844a2bffe3fa2eb0228669
  params:
    configs/cleaner.jsonnet:
      cat_detect_model_path: models/cat_detect/ru_cat_v5.ftz
      is_lower: true
      is_news_only: true
      is_russian_only: true
      lang_detect_model_path: models/lang_detect/lang_detect_v10.ftz
  outs:
  - path: output/0525_parsed.db
    md5: 73806e15e4e41285075c3f5c4a6d8ef5
annotate_0525:
  cmd: python3 -m purano.run_annotate --config configs/annotator.jsonnet --reannotate
    --sort-by-date --output-file output/0525_annotated.db --input-file output/0525_parsed.db
  deps:
  - path: configs/annotator.jsonnet
    md5: 687f17c97567d5d2376b35428bf47ab9
    size: 3070
  - path: models/text2title/ru_ft_text_embedder.pt
    md5: 70aa1ac520ed976360da2a6f46c12d06
    size: 198777
  - path: models/text2title/ru_ft_title_embedder.pt
    md5: d521fa3c5fb23fcc9613ca03cdfe5e8a
    size: 198777
  - path: output/0525_parsed.db
    md5: 73806e15e4e41285075c3f5c4a6d8ef5
    size: 127447040
  - path: purano/run_annotate.py
    md5: 054645ecf679834a8cad348d1dae1ba6
    size: 2432
  outs:
  - path: output/0525_annotated.db
    md5: f616983044d25fd5a6ecc1950a326a38
    size: 443076608
clustering_0525:
  cmd: python3 -m purano.run_clustering --config configs/clusterer.jsonnet --sort-by-date
    --output-file output/0525_clusters.json --input-file output/0525_annotated.db
  deps:
  - path: output/0525_annotated.db
    md5: f616983044d25fd5a6ecc1950a326a38
    size: 443076608
  - path: purano/clusterer/clusterer.py
    md5: ad9d6088fd5b6029201528b0a1a9e8be
    size: 8284
  - path: purano/run_clustering.py
    md5: 71eb27384b9bea718c73a4ebd51638f3
    size: 1736
  params:
    configs/clusterer.jsonnet:
      clustering:
        type: agglomerative
        affinity: precomputed
        linkage: average
        distance_threshold: 0.42
        n_clusters:
      distances.fix_hosts: true
      distances.fix_time: false
      distances.hosts_penalty: 5.0
      distances.time_penalty: 4.0
      fetching.embeddings.aggregation: concat
      fetching.embeddings.keys:
      - gen_title_embedding
      fetching.embeddings.weights:
      - 1.0
      fetching.entities_key: title_slovnet_ner
  outs:
  - path: output/0525_clusters.json
    md5: a54115bbd073b385772d9df711ad250e
    size: 2218707
evaluate_0525:
  cmd: python3 -m purano.run_evaluate --clustering-markup-tsv data/markup/ru_clustering_0525.tsv
    --original-json data/documents/ru_tg_0525.jsonl --threads-json output/0525_clusters.json
    --output-json output/0525_metrics.json
  deps:
  - path: data/documents/ru_tg_0525.jsonl
    md5: 6713a796a0f2d50a7ec63a744b68eee1
    size: 72232046
  - path: data/markup/ru_clustering_0525.tsv
    md5: 87705bb85e7e4a96662a6af85350f063
    size: 46518961
  - path: output/0525_clusters.json
    md5: a54115bbd073b385772d9df711ad250e
    size: 2218707
  - path: purano/run_evaluate.py
    md5: fd99b9efbeb0872c8ec27d745c7b2caa
    size: 1708
  outs:
  - path: output/0525_metrics.json
    md5: 607162e50a235dd5e16193f97c4a985b
    size: 831

